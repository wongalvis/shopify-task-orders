<!DOCTYPE html>
<html>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.1.1.js"
      integrity="sha256-16cdPddA6VdVInumRGo6IbivbERE8p7CQR3HzTBuELA="
      crossorigin="anonymous"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/maps/modules/map.js"></script>
    <script type="text/javascript"
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBho2Qw1DqXG9lOprH2z7PNE3FymIp7U4U&libraries=visualization&sensor=true_or_false">
    </script>
    <script src="https://cdn.jsdelivr.net/lodash/4.17.3/lodash.min.js"></script>

<body>

<script>
var app = angular.module("ordersapp", []); 
app.controller("indexCtrl", function($scope, $http) {
    $scope.orderslist = [];
    var avgincome = {ON: 36445, AK: 33062, AL: 23606, AR: 22883, AZ: 25715, CA: 30441, CO: 32357, CT: 39373, FL: 26582, GA: 25615, HI: 29736, IA: 28361};
    console.log (avgincome);

    var sumorders = function(orders){
        var total = orders.reduce(function (sum, element) {
            //console.log (element.total_price);
            return sum + Number(element.total_price);
        }, 0);
        return total;
    }

    var groupordersbylocation = function(orders) {
        var total = orders.reduce(function (result, element) {
            var postaladdr = element.billing_address.country_code+'.'+element.billing_address.province_code;
            result[postaladdr] = result[postaladdr] || [];
            //console.log (result[element.billing_address.province_code]);
            result[postaladdr].push(element);
            return result;
        }, {});
        return total;
    }
    
    var latlngs = function(orders) {
        var arr = orders.reduce(function (result, element) {
            var mapelement = new google.maps.LatLng(element.billing_address.latitude, element.billing_address.longitude)
            result.push(mapelement);
            return result;
        }, []);
        return arr;
    }
    
    var locationmap = function(mapdata, title, seriesname, targetid) {
        // format: '{point.properties.postal-code}' does not work :( while hardcoding 
        // var data as in the demo works
        var data = mapdata;
        //console.log (data);
        
        $.getJSON('http://code.highcharts.com/mapdata/custom/usa-and-canada.geo.json', function (geojson) {
    
            // Initiate the chart
            Highcharts.mapChart(targetid, {

                title: {
                    text: title
                },

                mapNavigation: {
                    enabled: true,
                    buttonOptions: {
                        verticalAlign: 'bottom'
                    }
                },

                colorAxis: {
                },

                series: [{
                    data: data,
                    mapData: geojson,
                    joinBy: ['hasc', 0],
                    keys: ['hasc', 'value'],
                    name: seriesname,
                    states: {
                        hover: {
                            color: '#a4edba'
                        }
                    },
                    dataLabels: {
                        enabled: true,
                        format: '{point.name}'
                    }
                }]
            });
        });
    }
    
    
    var makeheatmap = function(data){
        /* Data points defined as an array of LatLng objects */
        var heatmapData = [
          new google.maps.LatLng(37.785, -122.435)
        ];
        
        heatmapData = data;

        var origin = new google.maps.LatLng(33, -67);

        map = new google.maps.Map(document.getElementById('map'), {
          center: origin,
          zoom: 2,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        });

        var heatmap = new google.maps.visualization.HeatmapLayer({
          data: heatmapData
        });
        heatmap.setMap(map);
    }


    var getorders = function (page){
        $http.get("https://shopicruit.myshopify.com/admin/orders.json?page="+page+"&access_token=c32313df0d0ef512ca64d5b336a0d7c6")
        .then(function(response) {
            //$scope.myWelcome = response.data;
            //$scope.hi = response.data.orders[0].id;
            var orders = response.data.orders;
            console.log (page);
            $scope.orderslist = $scope.orderslist.concat(orders);
            console.log ($scope.orderslist);
            if (orders.length != 0) getorders(page+1);
            else {
                $scope.totalprice = sumorders($scope.orderslist).toFixed(5);
                $scope.avgprice = ($scope.totalprice/$scope.orderslist.length).toFixed(5);
                
                $scope.ordersbylocation = groupordersbylocation($scope.orderslist);
                console.log ($scope.ordersbylocation);
                $scope.locationorders = [];
                angular.forEach($scope.ordersbylocation, function(value, key) {
                    var entry = [];
                    entry.push(key);
                    entry.push(value.length);
                    this.push (entry);
                    //console.log (key);
                }, $scope.locationorders);
                console.log ($scope.locationorders);
                locationmap ($scope.locationorders, 'Number of Orders by Location', 'Orders count', 'nummap');
                
                $scope.locationsums = [];
                angular.forEach($scope.ordersbylocation, function(value, key) {
                    var entry = [];
                    entry.push(key);
                    entry.push(sumorders(value));
                    this.push (entry);
                }, $scope.locationsums);
                console.log ($scope.locationsums);
                locationmap ($scope.locationsums, 'Orders Price Sum by Location', 'Orders Price Sum', 'summap');
                
                $scope.locationavgs = [];
                angular.forEach($scope.ordersbylocation, function(value, key) {
                    var entry = [];
                    entry.push(key);
                    entry.push(sumorders(value)/value.length);
                    this.push (entry);
                }, $scope.locationavgs);
                console.log ($scope.locationavgs);
                locationmap ($scope.locationavgs, 'Orders Price Average by Location', 'Orders Price Average', 'avgmap');
                
                $scope.orderslatlng = latlngs ($scope.orderslist);
                console.log ($scope.orderslatlng);
                makeheatmap ($scope.orderslatlng);
                
                $scope.sortedorders = $scope.orderslist.sort(function (a, b) {
                  if (parseFloat(a.total_price) > parseFloat(b.total_price)) {
                    return -1;
                  }
                  if (parseFloat(a.total_price) < parseFloat(b.total_price)) {
                    return 1;
                  }
                  // a must be equal to b
                  return 0;
                });
                console.log ($scope.sortedorders);
            }
        });
    }

    getorders(1);
    //console.log ($scope.orderslocations);
    
    /*var data=    [
        ['US.CA', 728]
    ];*/
    console.log (_.defaults({ 'a': 1 }, { 'a': 3, 'b': 2 }));
});
</script>

<div ng-app="ordersapp" ng-controller="indexCtrl">
  
    <div style="width:100%; margin-bottom:1em;">
        <div style="width:48%; display:inline-block; margin-right:2%; height:100%; vertical-align:top;">Total Price: {{totalprice}}<br>Average Price: {{avgprice}}</div>
        <div style="width:48%; display:inline-block; height:100%; vertical-align:top;">Top 10 Orders:<br>
            <div ng-repeat="order in sortedorders|limitTo:10">{{order.billing_address.first_name}} {{order.billing_address.last_name}} from {{order.billing_address.city}}, {{order.billing_address.province}} (#{{order.order_number}}): {{order.total_price}}</div>
        </div>
    </div>

    
    <div id="nummap" style="width:48%; height:600px; display:inline-block; margin-right:2%;"></div>
    <div id="map" style="width:48%; height:600px; display:inline-block;"></div>
    
    <div id="summap" style="width:48%; height:600px; display:inline-block; margin-right:2%;"></div>
    <div id="avgmap" style="width:48%; height:600px; display:inline-block;"></div>


</div>


</body>
</html>


